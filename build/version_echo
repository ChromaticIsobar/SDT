#!/usr/bin/env bash

if [ "$#" -lt 1 ]; then
  PLT="LIB";
else
  PLT="$1";
fi
if [ "$#" -lt 2 ]; then
  PREFIX="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/..";
else
  PREFIX="$2";
fi
PLT="$(echo $PLT | tr a-z A-Z)"

LIB_VERSION="$(grep "#define SDT_ver " "${PREFIX}/src/SDT/SDTCommon.h")"
LIB_VERSION="$(echo "$LIB_VERSION" | while read -r -a wordarray; do echo "${wordarray[2]}"; done )"

PD_VERSION="$(cat "${PREFIX}/Pd/VERSION")";

MAX_VERSION="$(grep "\"version\"" "${PREFIX}/MaxPackage/package-info.json")";
MAX_VERSION="$(echo "$MAX_VERSION" | while read -r -a wordarray; do echo "${wordarray[2]}"; done )"
MAX_VERSION="$(echo "$MAX_VERSION" | tr -d \" | tr -d ,)";
case $PLT in
  "LIB" )
    SDT_VERSION="${LIB_VERSION}";;
  "PD" )
    SDT_VERSION="${PD_VERSION}-${LIB_VERSION}";;
  "MAX" )
    SDT_VERSION="${MAX_VERSION}-${LIB_VERSION}";;
  "TAG" )
    SDT_VERSION="v${LIB_VERSION}-Max${MAX_VERSION}-Pd${PD_VERSION}";;
   * )
    >&2 echo "platform should be either 'LIB', 'PD', 'MAX', or 'TAG', not '${PLT}'" && exit 1;;
esac
SDT_VERSION=${SDT_VERSION//[[:blank:]]/}
echo "${SDT_VERSION}"